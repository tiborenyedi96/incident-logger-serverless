name: Infrastructure plan
permissions:
    id-token: write
    pull-requests: write
    contents: read
on:
    pull_request:
        types: [opened, reopened, synchronize]
        paths:
            - "infrastructure/**"
jobs:
    infrastructure_plan:
        runs-on: ubuntu-latest
        steps:
            - name: Check out repository
              uses: actions/checkout@v6

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v5.1.0
              with:
                aws-region: eu-central-1
                role-to-assume: ${{ secrets.AWS_TERRAFORM_PLAN_ROLE_ARN }}
                role-session-name: AWSTerraformSession

            - name: Terraform installation
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: "1.13.5"

            - name: Running terraform commands
              working-directory: infrastructure
              env:
                TF_VAR_alarm_email: ${{ secrets.ALARM_EMAIL }}
              run: |
                terraform init
                terraform fmt -recursive -check
                terraform validate
                terraform plan -no-color -input=false -out=tfplan
                terraform show -json tfplan > plan.json

            - name: Upload plan JSON
              uses: actions/upload-artifact@v4
              with:
                name: terraform-plan-json
                path: infrastructure/plan.json

            - name: Generate PR comment from plan
              uses: actions/github-script@v7
              with:
                script: |
                  const fs = require('fs');
                  const planRaw = fs.readFileSync('infrastructure/plan.json', 'utf8');
                  const plan = JSON.parse(planRaw);
                  const changes = plan.resource_changes || [];
                  let creates = 0;
                  let updates = 0;
                  let deletes = 0;

                  for (const rc of changes) {
                    const action = rc.change.actions[0];
                    if (action === "create") creates++;
                    if (action === "update") updates++;
                    if (action === "delete") deletes++;
                  }

                  let body = `
                  ### Terraform Change Summary

                  | Action | Count |
                  |-------|-------|
                  | [+] Create | ${creates} |
                  | [~] Update | ${updates} |
                  | [-] Delete | ${deletes} |

                  ### Changed Resources
                  `;

                  for (const rc of changes) {
                    const name = `${rc.type}.${rc.name}`;
                    const action = rc.change.actions[0];
                    body += `- \`${name}\` (${action})\n`;
                  }

                  body += `
                  ---
                  Full JSON plan is available as an artifact: terraform-plan-json
                  `;

                  github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: body
                  });