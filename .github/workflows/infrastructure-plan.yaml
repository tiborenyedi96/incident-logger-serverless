name: Infrastructure plan
env:
  ACTIONS_STEP_DEBUG: true
permissions:
    id-token: write
    pull-requests: write
    contents: read
on:
    pull_request:
        types: [opened, reopened, synchronize]
        paths:
            - "infrastructure/**"
jobs:
    infrastructure_plan:
        runs-on: ubuntu-latest
        steps:
            - name: Check out repository
              uses: actions/checkout@v6

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v5.1.0
              with:
                aws-region: eu-central-1
                role-to-assume: arn:aws:iam::299097238534:role/incident-logger-github-actions-terraform-role
                role-session-name: AWSTerraformSession

            - name: Terraform installation
              uses: hashicorp/setup-terraform@v3
              with:
                terraform_version: "1.13.5"

            - name: Running terraform commands
              working-directory: infrastructure
              run: |
                terraform init
                terraform fmt -recursive -check
                terraform validate
                terraform plan -no-color -input=false -out=tfplan
                terraform show -json tfplan > plan.json

            - name: Generate PR comment from plan
              uses: actions/github-script@v7
              with:
                script: |
                  const fs = require('fs');
                  const planRaw = fs.readFileSync('infrastructure/plan.json', 'utf8');
                  const plan = JSON.parse(planRaw);
                  const changes = plan.resource_changes || [];
                  let creates = 0;
                  let updates = 0;
                  let deletes = 0;

                  for (const rc of changes) {
                    const action = rc.change.actions[0];
                    if (action === "create") creates++;
                    if (action === "update") updates++;
                    if (action === "delete") deletes++;
                  }
                  let body = `
                  ### Terraform Change Summary

                  | Action | Count |
                  |-------|-------|
                  | [+] Create | ${creates} |
                  | [~] Update | ${updates} |
                  | [-] Delete | ${deletes} |

                  ### Changed Resources
                  `;

                  for (const rc of changes) {
                    const name = `${rc.type}.${rc.name}`;
                    const action = rc.change.actions[0];
                    body += `- \`${name}\` (${action})\n`;
                  }

                  body += `
                  <details>
                    <summary>Full Plan</summary>

                  \`\`\`
                  ${planRaw}
                  \`\`\`

                  </details>
                  `;
                  github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: body
                   });